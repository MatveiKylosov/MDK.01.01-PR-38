@using Shop.Data.ViewModell
@model VMItems

@{
    Layout = "_Layout";
}

<h2>Все предметы</h2>

<div>
    <input type="text" id="search" placeholder="Поиск..." value="@Model.search">
    <button onclick="UpdateUrl()">Найти</button>

    <select onchange="UpdateUrl()">
        <option value="0">Выбрать ...</option>
        @{
            foreach (var Category in Model.Categories)
            {
                if (Category.Id == Model.SelectCategory)
                {
                    <option selected="selected" value="@Category.Id"> @Category.Name</option>
                }
                else
                {
                    <option value="@Category.Id">@Category.Name</option>
                }
            }
        }
    </select>

    <select id="sortOrder" onchange="UpdateUrl()">
        @{
            if (Model.SortOrder == "desc")
            {
                <option value="asc">от меньшего к большему</option>
                <option value="desc" selected="selected">наоборот</option>
            }
            else
            {
                <option value="asc" selected="selected">от меньшего к большему</option>
                <option value="desc">наоборот</option>
            }
        }
    </select>

    <script>
        function UpdateUrl() {
            var search = document.getElementById('search').value;
            var category = document.querySelector('select[onchange="UpdateUrl()"]').value;
            var sortOrder = document.getElementById('sortOrder').value;
            window.location = "/Items/List?id=" + category + "&sortOrder=" + sortOrder + "&search=" + search;
        }
    </script>
</div>

@{
    foreach (var item in Model.Items.OrderBy(i => Model.SortOrder == "desc" ? -i.Price : i.Price))
    {
        if (item.Category.Id == Model.SelectCategory)
        {
            <div class="item">
                <img src="/img/@item.Img" />
                <div></div>
                <div class="basket">
                    <div class="button" id="@item.Id">
                        В корзину
                    </div>
                    <div class="count" style="display: none;">
                        <div class="button min">-</div>
                        <div class="text">1</div>
                        <div class="button max">+</div>
                    </div>
                </div>

                <div class="data">
                    <h3>Модель: @item.Name</h3>
                    <div>Цена: @item.Price.ToString("c")</div>
                    <div>Категория: @item.Category.Name</div>
                    <div>Описание: @item.Description</div>
                </div>
                <a href="/Items/Update?id=@item.Id">Изменить</a>
                <a href="/Items/Delete?id=@item.Id">Удалить</a>
            </div>
        }
    }
}

<script>
    $(document).ready(function () {

        $(".item").children(".basket").children(".button").off().click(function () {
            var idItem = $(this).attr('id');
            var basketInfo = localStorage.getItem('BusketInfo');
            var idItems = Array.isArray(JSON.parse(basketInfo)) ? JSON.parse(basketInfo) : [];
            idItems.push(idItem);
            console.log(idItem);
            localStorage.setItem('BusketInfo', JSON.stringify(idItems));

            $(this).parent().children(".count").show();
            $(this).hide();
            $.ajax({
                url: '@Url.Action("Basket", "Items")',
                contentType: "application/json; charset=utf-8",
                data: { idItem: $(this).attr('id') },
                dataType: "json",
                success: SuccessBasket,
                error: AjaxError
            });
        });

        $(".count").children(".min").click(function () {
            var idItem = $(this).parent().parent().children('.button').attr('id');
            var count = $(this).parent().children(".text").text();
            count--;
            if (count == 0) {
                $(this).parent().parent().children('.button').show();
                $(this).parent().parent().children('.count').hide();

                var basketInfo = localStorage.getItem('BusketInfo');
                var idItems = basketInfo ? JSON.parse(basketInfo) : [];
                idItems = idItems.filter(function (item) {
                    return item != idItem; // Удаляем элемент с idItem из массива
                });
                localStorage.setItem('BusketInfo', JSON.stringify(idItems));
            } else {
                $(this).parent().children(".text").text(count);
            }

            $.ajax({
                url: '@Url.Action("BasketCount", "Items")',
                contentType: "application/json; charset=utf-8",
                data: { idItem: idItem, count: count },
                dataType: "json",
                success: SuccessBasket,
                error: AjaxError
            });
        });


        $(".count").children(".max").click(function () {
            var idItem = $(this).parent().parent().children('.button').attr('id');
            var count = $(this).parent().children(".text").text();
            count++;

            $(this).parent().children(".text").text(count);

            $.ajax({
                url: '@Url.Action("BasketCount", "Items")',
                contentType: "application/json; charset=utf-8",
                data: { idItem: idItem, count: count },
                dataType: "json",
                success: SuccessBasket,
                error: AjaxError
            })
        })

        function SuccessBasket(data) {
            //console.log(data);
            $(".CountJocki").text(data.countItems == 0 ? "0" : data.countItems);
        }

        function AjaxError() {
            console.log("Ошибка выполнения ajax");
        }
    });
</script>
